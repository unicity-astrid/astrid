/// WIT interface definitions for Astralis WASM-sandboxed plugins.
///
/// Package: astralis:plugin@0.1.0
///
/// This file defines the canonical contract between the Astralis host runtime
/// and WASM plugin guests. Near-term it documents the Extism host function
/// contract (WS-3); long-term it becomes direct Component Model imports/exports
/// when migrating to the Component Model (WS-8).

package astralis:plugin@0.1.0;

/// Shared types used across host and guest interfaces.
interface types {
    /// Log severity level for structured plugin logging.
    enum log-level {
        trace,
        debug,
        info,
        warn,
        error,
    }

    /// A key-value pair used for typed header lists.
    record key-value-pair {
        key: string,
        value: string,
    }

    /// Context passed to a plugin when a hook fires.
    record plugin-context {
        /// The event name that triggered this hook (e.g. "pre-tool-call").
        event: string,
        /// Session ID for the current interaction.
        session-id: string,
        /// Authenticated user ID, if available.
        user-id: option<string>,
        /// Event-specific payload as a JSON string.
        data: option<string>,
    }

    /// Result returned by a plugin after hook execution.
    record plugin-result {
        /// Action directive (e.g. "continue", "abort", "modify").
        action: string,
        /// Optional payload as a JSON string.
        data: option<string>,
    }

    /// Input arguments for a tool invocation.
    record tool-input {
        /// Tool name to invoke.
        name: string,
        /// Tool arguments as a JSON string.
        arguments: string,
    }

    /// Output from a tool execution.
    record tool-output {
        /// Result content as a JSON string.
        content: string,
        /// Whether this output represents an error.
        is-error: bool,
    }

    /// Metadata describing a tool that a plugin exposes.
    record tool-definition {
        /// Unique tool name.
        name: string,
        /// Human-readable description.
        description: string,
        /// JSON Schema describing the tool's input parameters.
        input-schema: string,
    }

    /// HTTP response returned by the host.
    record http-response {
        /// HTTP status code.
        status: u16,
        /// Response headers.
        headers: list<key-value-pair>,
        /// Response body.
        body: string,
    }
}

/// Host-provided functions that plugins can call.
///
/// All operations are capability-gated and audited by the Astralis runtime.
/// Plugins never bypass the security model — the host enforces workspace
/// boundaries, budget limits, and capability tokens on every call.
interface host {
    use types.{log-level, key-value-pair, http-response};

    /// Emit a structured log message attributed to the calling plugin.
    log: func(level: log-level, message: string);

    /// Perform a capability-gated HTTP request.
    ///
    /// The host enforces allow-lists and rate limits based on the plugin's
    /// capability tokens.
    http-request: func(
        method: string,
        url: string,
        headers: list<key-value-pair>,
        body: option<string>,
    ) -> result<http-response, string>;

    /// Read a file within the plugin's workspace boundary.
    ///
    /// Paths are resolved relative to the workspace root. Attempts to escape
    /// the boundary return an error.
    read-file: func(path: string) -> result<string, string>;

    /// Write a file within the plugin's workspace boundary.
    ///
    /// Paths are resolved relative to the workspace root. Attempts to escape
    /// the boundary return an error.
    write-file: func(path: string, content: string) -> result<_, string>;

    /// Read a value from the plugin's scoped key-value store.
    ///
    /// Keys are namespaced to `wasm:{plugin_id}` in the underlying
    /// `ScopedKvStore`, so plugins cannot access each other's data.
    kv-get: func(key: string) -> result<option<string>, string>;

    /// Write a value to the plugin's scoped key-value store.
    kv-set: func(key: string, value: string) -> result<_, string>;

    /// Read a configuration value from the plugin's manifest.
    get-config: func(key: string) -> result<option<string>, string>;
}

/// The plugin world — the full composed contract.
///
/// A conforming plugin imports the `host` interface and exports the three
/// entry-point functions below.
world plugin {
    import host;

    /// Execute a lifecycle hook (e.g. pre-tool-call, post-response).
    ///
    /// Receives the hook context and returns a directive telling the host
    /// how to proceed.
    export run-hook: func(ctx: types.plugin-context) -> types.plugin-result;

    /// Execute a tool invocation routed to this plugin.
    export execute-tool: func(input: types.tool-input) -> types.tool-output;

    /// Describe the tools this plugin provides.
    ///
    /// Called during plugin registration so the host can advertise
    /// available tools to the LLM.
    export describe-tools: func() -> list<types.tool-definition>;
}
