# astrid-vfs

[![Crates.io](https://img.shields.io/crates/v/astrid-vfs)](https://crates.io/crates/astrid-vfs)
[![License: MIT OR Apache-2.0](https://img.shields.io/badge/License-MIT%20OR%20Apache--2.0-blue.svg)](../../LICENSE-MIT)
[![MSRV: 1.93](https://img.shields.io/badge/MSRV-1.93-blue)](https://www.rust-lang.org)

Secure, capability-based virtual file system and sandboxing for Astralis OS.

`astrid-vfs` is the storage isolation engine for the Astralis OS runtime. It implements a secure virtual filesystem layer that translates abstract capabilities into safe host operations, completely isolating agent workloads from the underlying host filesystem. By utilizing `cap-std` for OS-level sandboxing and a strict capability-based access model, it ensures that path traversal, symlink escapes, and arbitrary file accesses are systematically impossible.

## Core Features

* **Capability-Based Security**: File operations require cryptographic handles (`DirHandle`, `FileHandle`) issued by `astrid-capabilities`. Raw paths alone grant zero access to the filesystem.
* **Mathematical Path Isolation**: Lexical path resolution and `cap-std` ambient authority boundaries guarantee that workloads cannot traverse above their sandbox root using `..` or absolute path injection.
* **Copy-on-Write (CoW) Overlay**: The stackable `OverlayVfs` implementation allows mounting read-only base directories with ephemeral read-write upper layers, enabling lightweight, discardable agent workspaces.
* **Resource Quotas**: Built-in asynchronous semaphores prevent file descriptor exhaustion (capped at 64 concurrent open files per host VFS instance) and limit file sizes to prevent OOM attacks (50MB cap during memory reads and copy-ups).

## Architecture

The crate centers around the asynchronous `Vfs` trait, which defines a standard interface for sandboxed filesystem operations.

### Host Filesystem (`HostVfs`)
The `HostVfs` translates VFS operations into physical disk operations. It maintains a registry of active `DirHandle` and `FileHandle` instances. When a capability is registered via `register_dir`, it opens an ambient handle to the directory that strictly confines all subsequent operations, ensuring the operating system itself enforces the sandbox boundary.

### Overlay Filesystem (`OverlayVfs`)
The `OverlayVfs` composes two `Vfs` implementations (typically two `HostVfs` instances).
* **Reads**: Attempted first in the upper layer, falling back to the lower layer if the file is absent.
* **Writes**: Strictly confined to the upper layer. If an existing lower-layer file is opened for writing, the overlay performs a transparent copy-up to the upper layer before executing the write. Concurrency is managed via `DashMap` locks to prevent duplicate copy-ups across asynchronous tasks.

### Path Resolution
The `path::resolve_path` utility provides purely computational path evaluation. It strips malicious absolute path requests and blocks any attempt to navigate above the sandbox root, serving as the first line of defense before yielding to the `cap-std` boundary.

## Quick Start

### Establishing a Host Sandbox

```rust
use astrid_vfs::{HostVfs, Vfs};
use astrid_capabilities::{DirHandle, FileHandle};
use std::path::PathBuf;

// Initialize the host VFS
let vfs = HostVfs::new();

// The host daemon grants a capability to a specific physical path
let root_handle = DirHandle::new();
vfs.register_dir(root_handle.clone(), PathBuf::from("/var/astralis/sandbox/agent-1")).await.unwrap();

// Operations use the handle. Paths are strictly resolved within the boundary.
let file_handle = vfs.open(&root_handle, "output.txt", true, false).await.unwrap();
vfs.write(&file_handle, b"Data generated by sandbox").await.unwrap();
vfs.close(&file_handle).await.unwrap();
```

### Composing an Overlay

```rust
use astrid_vfs::{HostVfs, OverlayVfs, Vfs};

// Create lower (read-only base) and upper (read-write ephemeral) filesystems
let lower = Box::new(HostVfs::new());
let upper = Box::new(HostVfs::new());

// Bind them together into an overlay workspace
let overlay = OverlayVfs::new(lower, upper);
```

## Development

```bash
cargo test -p astrid-vfs
```

## License

This project is dual-licensed under either the [MIT License](../../LICENSE-MIT) or the [Apache License, Version 2.0](../../LICENSE-APACHE), at your option.
